<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/js/script.js"></script>
	<title>Code 2gether</title>
</head>
<body>

	

	<!-- Page Content -->
	<div id="content">
		<nav class="navbar navbar-dark bg-dark">
			<!-- <button id="sidebarCollapse" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
			</button> -->
			<a></a>
			<input class="input" type="text" id="username" placeholder="username" style="margin-top: 4px;">
		</nav>
		<div class="wrapper">
			<nav id="sidebar">
				<ul class="list-unstyled components">
					<li>
						<a class="settings">
							<svg class="sideicon bi bi-gear" width="40px" height="40px" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
								<path fill-rule="evenodd" d="M10.837 3.626c-.246-.835-1.428-.835-1.674 0l-.094.319A1.873 1.873 0 016.377 5.06l-.292-.16c-.764-.415-1.6.42-1.184 1.185l.159.292a1.873 1.873 0 01-1.115 2.692l-.319.094c-.835.246-.835 1.428 0 1.674l.319.094a1.873 1.873 0 011.115 2.693l-.16.291c-.415.764.42 1.6 1.185 1.184l.292-.159a1.873 1.873 0 012.692 1.115l.094.319c.246.835 1.428.835 1.674 0l.094-.319a1.873 1.873 0 012.693-1.115l.291.16c.764.415 1.6-.42 1.184-1.185l-.159-.291a1.873 1.873 0 011.115-2.693l.319-.094c.835-.246.835-1.428 0-1.674l-.319-.094a1.873 1.873 0 01-1.115-2.692l.16-.292c.415-.764-.42-1.6-1.185-1.184l-.291.159a1.873 1.873 0 01-2.693-1.115l-.094-.319zm-2.633-.283c.527-1.79 3.064-1.79 3.592 0l.094.319a.873.873 0 001.255.52l.292-.16c1.64-.892 3.434.901 2.54 2.541l-.159.292a.873.873 0 00.52 1.255l.319.094c1.79.527 1.79 3.064 0 3.592l-.319.094a.873.873 0 00-.52 1.255l.16.292c.893 1.64-.902 3.434-2.541 2.54l-.292-.159a.873.873 0 00-1.255.52l-.094.319c-.527 1.79-3.065 1.79-3.592 0l-.094-.319a.873.873 0 00-1.255-.52l-.292.16c-1.64.893-3.433-.902-2.54-2.541l.159-.292a.873.873 0 00-.52-1.255l-.319-.094c-1.79-.527-1.79-3.065 0-3.592l.319-.094a.873.873 0 00.52-1.255l-.16-.292c-.892-1.64.901-3.433 2.541-2.54l.292.159a.873.873 0 001.255-.52l.094-.319z" clip-rule="evenodd"/>
								<path fill-rule="evenodd" d="M10 7.754a2.246 2.246 0 100 4.492 2.246 2.246 0 000-4.492zM6.754 10a3.246 3.246 0 116.492 0 3.246 3.246 0 01-6.492 0z" clip-rule="evenodd"/>
							</svg>
						</a>
						<a class="chat">
							<svg class="sideicon bi bi-chat-dots" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
								<path fill-rule="evenodd" d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
								<path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
							</svg></a>
						<a class="users">
							<svg class="sideicon bi bi-people" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
								<path fill-rule="evenodd" d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.995-.944v-.002.002zM7.022 13h7.956a.274.274 0 0 0 .014-.002l.008-.002c-.002-.264-.167-1.03-.76-1.72C13.688 10.629 12.718 10 11 10c-1.717 0-2.687.63-3.24 1.276-.593.69-.759 1.457-.76 1.72a1.05 1.05 0 0 0 .022.004zm7.973.056v-.002.002zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10c-1.668.02-2.615.64-3.16 1.276C1.163 11.97 1 12.739 1 13h3c0-1.045.323-2.086.92-3zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
							</svg>
						</a>
						<a class="download">
							<svg class="sideicon bi bi-file-earmark-arrow-down" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
								<path d="M4 1h5v1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6h1v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2z"/>
								<path d="M9 4.5V1l5 5h-3.5A1.5 1.5 0 0 1 9 4.5z"/>
								<path fill-rule="evenodd" d="M5.646 9.146a.5.5 0 0 1 .708 0L8 10.793l1.646-1.647a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 0-.708z"/>
								<path fill-rule="evenodd" d="M8 6a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0v-4A.5.5 0 0 1 8 6z"/>
							</svg>
						</a>
					</li>
				</ul>
			</nav>
			<div id="sideMenu" class="hidden">
				<div class="menu settingsMenu" style="display: none;">
					<h3>Settings</h3> </br>
					<label for="language">Language : </label>
					<select id="language" name="language" class="input">
						<option>abap</option>
						<option>aes</option>
						<option>apex</option>
						<option>azcli</option>
						<option>bat</option>
						<option>c</option>
						<option>cameligo</option>
						<option>clojure</option>
						<option>coffeescript</option>
						<option>cpp</option>
						<option>csharp</option>
						<option>csp</option>
						<option>css</option>
						<option>dockerfile</option>
						<option>fsharp</option>
						<option>go</option>
						<option>graphql</option>
						<option>handlebars</option>
						<option>html</option>
						<option>ini</option>
						<option>java</option>
						<option selected>javascript</option>
						<option>json</option>
						<option>kotlin</option>
						<option>less</option>
						<option>lua</option>
						<option>markdown</option>
						<option>mips</option>
						<option>msdax</option>
						<option>mysql</option>
						<option>objective-c</option>
						<option>pascal</option>
						<option>pascaligo</option>
						<option>perl</option>
						<option>pgsql</option>
						<option>php</option>
						<option>plaintext</option>
						<option>postiats</option>
						<option>powerquery</option>
						<option>powershell</option>
						<option>pug</option>
						<option>python</option>
						<option>r</option>
						<option>razor</option>
						<option>redis</option>
						<option>redshift</option>
						<option>restructuredtext</option>
						<option>ruby</option>
						<option>rust</option>
						<option>sb</option>
						<option>scheme</option>
						<option>scss</option>
						<option>shell</option>
						<option>sol</option>
						<option>sql</option>
						<option>st</option>
						<option>swift</option>
						<option>tcl</option>
						<option>twig</option>
						<option>typescript</option>
						<option>vb</option>
						<option>xml</option>
						<option>yaml</option>
					</select> </br></br>
					<label for="theme">Theme : </label>
					<select id="theme" name="theme" class="input">
						<option value="vs">Visual Studio</option>
						<option value="vs-dark" selected>Visual Studio Dark</option>
						<option value="hc-black">High Contrast Dark</option>
					</select> </br></br>
					<label for="goto">Go to line :</label>
					<input id="goto" name="goto" value="0" type="number" class="input">
				</div>
				<div class="menu chatMenu" style="display: none;">
					<h3>Chat</h3>
					<div id="messages">
					</div>
					<input class="input" type="text" id="send" placeholder="Message...">
				</div>
				<div class="menu usersMenu" style="display: none;">
					<h3>Users list</h3>
					<div id="usersList">
						
						<% roomInfos.users.forEach(function(user, index) { %>
							<label for="user<%= index %>" class=" userLabel <% if (!user.connected) { %> disconnected <% } %>"><%= user.pseudo %></label>
							<div class="right">
								<svg class="bi bi-pen" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="margin-top:-5px;">
									<path fill-rule="evenodd" d="M5.707 13.707a1 1 0 0 1-.39.242l-3 1a1 1 0 0 1-1.266-1.265l1-3a1 1 0 0 1 .242-.391L10.086 2.5a2 2 0 0 1 2.828 0l.586.586a2 2 0 0 1 0 2.828l-7.793 7.793zM3 11l7.793-7.793a1 1 0 0 1 1.414 0l.586.586a1 1 0 0 1 0 1.414L5 13l-3 1 1-3z"/>
									<path fill-rule="evenodd" d="M9.854 2.56a.5.5 0 0 0-.708 0L5.854 5.855a.5.5 0 0 1-.708-.708L8.44 1.854a1.5 1.5 0 0 1 2.122 0l.293.292a.5.5 0 0 1-.707.708l-.293-.293z"/>
									<path d="M13.293 1.207a1 1 0 0 1 1.414 0l.03.03a1 1 0 0 1 .03 1.383L13.5 4 12 2.5l1.293-1.293z"/>
								</svg>
								<input type="checkbox" id="user<%= index %>" class="userCheckbox" style="margin-top:7px;" <% if (user.edit) { %> checked <% } %> <% if (!host) { %> disabled <% } %>>
							</div> <br>
						<% }); %>
					</div>
					<input type="checkbox" id="allowEdit" name="allowEdit" style="margin-top:7px;" <% if (!host) { %> disabled <% } %> <% if (roomInfos.allowEdit) { %> checked <% } %>>
				<label for="allowEdit" class="inline" >Allow new users to edit</label>
				</div>
			</div>
			
			
			<div id="container"></div>


		</div>
	</div>   

	<script src="/socket.io/socket.io.js"></script>
	<script src="scripts/monaco-editor/dev/vs/loader.js"></script>
	<script>
		let userID, autoAllowEdit = <%= roomInfos.allowEdit %>, edit;
		let socket = io('http://localhost:8080', {query: "val="+window.location.pathname.substr(1)});

		console.log("Connecting to " + window.location.pathname.substr(1) + "...")
		require.config({ paths: { 'vs': 'scripts/monaco-editor/dev/vs' }});
	
		require(['vs/editor/editor.main'], function() {
			console.log(edit);
			editor = monaco.editor.create(document.getElementById('container'), {
				value: `<%- roomInfos.code %>`,
				language: 'javascript',
				//automaticLayout: true,
				readOnly: !edit,
				theme: "vs-dark",
				scrollBeyondLastLine: false,
			});

			setLanguage("<%- roomInfos.language %>", editor);

		});

		socket.on('connect', () => {
			socket.emit('connected');
			console.log("Connected")
		});


		socket.on('info', function(rep) {
			console.log(rep);
			$("#username").val(rep.pseudo)
			$('label[for=user'+ rep.user +']').addClass("user").removeClass("disconnected");
			edit = rep.edit;
			try {
				if(rep.edit) editor.updateOptions({ readOnly: false}) ;
			}
			catch(error) {}
			userID = rep.user;
		});

		socket.on('edit', function(code) {
			editor.setValue(code);
		});

		socket.on('changeLanguage', function(language) {
			setLanguage(language, editor);
		});

		socket.on('allowEdit', function(allowEdit) {
			$("#allowEdit").prop("checked", allowEdit)
			autoAllowEdit = allowEdit;
		});

		socket.on('changePseudo', function(user, pseudo) {
			$('label[for=user'+ user +']').text(pseudo);
			$(".user"+user).text(pseudo);
		});

		socket.on('newUser', function(user, pseudo) {
			if($("#user"+ user).length==0) {
				let checked, classUser;
				autoAllowEdit ? checked="checked" : checked="";
				user==userID ? classUser = "user" : classUser = "";
				if(user=="0") checked="checked";
				$("#usersList").append(`<label for="user`+user+`" class="`+classUser+`">`+pseudo+`</label>
										<div class="right">
											<svg class="bi bi-pen" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="margin-top:-5px;">
												<path fill-rule="evenodd" d="M5.707 13.707a1 1 0 0 1-.39.242l-3 1a1 1 0 0 1-1.266-1.265l1-3a1 1 0 0 1 .242-.391L10.086 2.5a2 2 0 0 1 2.828 0l.586.586a2 2 0 0 1 0 2.828l-7.793 7.793zM3 11l7.793-7.793a1 1 0 0 1 1.414 0l.586.586a1 1 0 0 1 0 1.414L5 13l-3 1 1-3z"/>
												<path fill-rule="evenodd" d="M9.854 2.56a.5.5 0 0 0-.708 0L5.854 5.855a.5.5 0 0 1-.708-.708L8.44 1.854a1.5 1.5 0 0 1 2.122 0l.293.292a.5.5 0 0 1-.707.708l-.293-.293z"/>
												<path d="M13.293 1.207a1 1 0 0 1 1.414 0l.03.03a1 1 0 0 1 .03 1.383L13.5 4 12 2.5l1.293-1.293z"/>
											</svg>
											<input type="checkbox" id="user`+user+`" class="userCheckbox" style="margin-top:7px;" `+checked+` <% if (!host) { %> disabled <% } %>>
										</div> <br>`);
			}
			else {
				$("label[for=user"+ user +"]").removeClass("disconnected");
			}

		});

		socket.on('userDisconnected', function(user) {
			$("label[for=user"+ user +"]").addClass("disconnected");
		});

		socket.on('changeEdit', function(editUser, edit) {
			$("#user"+ editUser).prop("checked", edit);
			if(editUser==userID) editor.updateOptions({ readOnly: !edit})
		});

		socket.on('newMsg', function(pseudo, user, msg) {
			$("#messages").append("<p class='msg'> <span class='user" + user + " bold'>"+pseudo+"</span>: "+ msg+"</p>")
		});





		window.addEventListener('resize', function(){
			editor.layout();
		});

		$("#container").on("keyup", function(event) {
			socket.emit('edit', editor.getValue());
		})
		
		$("#theme").change(function(){
			monaco.editor.setTheme($(this).val());
		});

		$("#username").change(function(){
			socket.emit('changePseudo', $(this).val());
			$('label[for=user'+ userID +']').text($(this).val());
			$(".user"+userID).text($(this).val());
		});

		$("#goto").on("keyup", function(event) {
			if(event.keyCode==13) {
				editor.revealPositionInCenter({ lineNumber: parseInt($(this).val()), column: 1 });
			}
		});

		<% if (host) { %>  

		$("#allowEdit").change(function(){
			let allowEdit;
			$(this).prop("checked") ? allowEdit = true : allowEdit = false ;
			socket.emit('allowEdit', allowEdit);
			autoAllowEdit = allowEdit;
		});

		$("#language").change(function(){
			let editorModel = editor.getModel();
			monaco.editor.setModelLanguage(editorModel, $(this).val());
			socket.emit('changeLanguage', $(this).val());
		});

		$(document).on('change',".userCheckbox", function () {
			socket.emit('changeEdit', $(this).prop("id").substr("user".length), $(this).prop("checked"));
		});

		<% } %>

		$("#send").on("keyup", function(event) {
			if(event.keyCode==13) {
				socket.emit('sendMsg', $(this).val());
				$("#messages").append("<p class='msg'> <span class='user" + userID + " bold'>"+$("#username").val()+"</span>: "+ $(this).val()+"</p>")
				$(this).val("");
			}
		});

		$('.download').on('click', function () {
			let editorModel = editor.getModel();
			let id = editorModel.getLanguageIdentifier().id;
			let ext = monaco.languages.getLanguages()[id-1].extensions[0].substr(1)
			let iframe = $('<iframe class="iframeDownload" src="' + window.location.pathname + '/download/' + ext + '" style="display:none"></iframe>');
			$(".download").append(iframe);
		});

		function setLanguage(language, editor) {
			let editorModel = editor.getModel();
			monaco.editor.setModelLanguage(editorModel, language);
			$("#language").val(language);
		}

	</script>


</body>
</html>